<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<meta name="apple-mobile-web-app-title" content="Espresso">
<meta name="theme-color" content="#C4793A">
<title>Espresso Tracker</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600&family=DM+Serif+Display:ital@0;1&display=swap" rel="stylesheet">
<style>
* { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; }
:root {
  --bg:#F2F0EB; --card:#FFFFFF; --text-primary:#1A1814; --text-secondary:#8A8580;
  --accent:#C4793A; --accent-light:#F5EDE3; --border:#E8E4DE;
  --toggle-bg:#E8E4DE; --toggle-active:#1A1814;
  --shadow:0 1px 3px rgba(0,0,0,0.06),0 4px 16px rgba(0,0,0,0.04);
  --green:#27AE60; --green-bg:#EAF7EF;
  --yellow:#E4A000; --yellow-bg:#FEF6E0;
  --red:#E53935; --red-bg:#FDEAEA;
}

/* ‚îÄ‚îÄ PWA: Vollbild-Layout (kein Phone-Frame im echten Ger√§t) ‚îÄ‚îÄ */
body {
  font-family:'DM Sans',sans-serif;
  background:var(--bg);
  min-height:100vh;
  min-height:100dvh;
  display:flex;
  justify-content:center;
  align-items:flex-start;
  overflow:hidden;
}

/* App-Wrapper: im Browser zeigt Phone-Frame, als PWA vollbild */
.app-wrapper {
  width:100%;
  max-width:430px;
  height:100vh;
  height:100dvh;
  background:var(--bg);
  display:flex;
  flex-direction:column;
  overflow:hidden;
  position:relative;
}

/* Safe-area f√ºr iPhone-Notch / Dynamic Island */
.safe-top {
  height: env(safe-area-inset-top, 44px);
  background: var(--bg);
  flex-shrink: 0;
}
.safe-bottom-pad {
  height: env(safe-area-inset-bottom, 20px);
  flex-shrink: 0;
}

.screen { flex:1; display:none; flex-direction:column; overflow:hidden; }
.screen.active { display:flex; }

.top-bar { display:grid; grid-template-columns:1fr auto 1fr; align-items:center; padding:10px 20px 0; flex-shrink:0; }
.top-bar-left { display:flex; justify-content:flex-start; }
.top-bar-center { text-align:center; }
.top-bar-center h1 { font-family:'DM Serif Display',serif; font-size:24px; color:var(--text-primary); line-height:1; font-style:italic; white-space:nowrap; }
.top-bar-center p { font-size:11px; color:var(--text-secondary); margin-top:2px; }
.top-bar-right { display:flex; justify-content:flex-end; }
.nav-btn { background:var(--card); border:none; border-radius:12px; padding:8px 13px; font-family:'DM Sans',sans-serif; font-size:12px; font-weight:500; color:var(--text-secondary); cursor:pointer; box-shadow:var(--shadow); white-space:nowrap; }

/* ‚îÄ‚îÄ SCREEN 1 ‚îÄ‚îÄ */
.app-content { flex:1; display:flex; flex-direction:column; padding:10px 20px 0; gap:9px; overflow:hidden; }
.card { background:var(--card); border-radius:20px; padding:13px 16px; box-shadow:var(--shadow); }
.card-label { font-size:11px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:9px; }
.bean-row { display:flex; align-items:center; justify-content:space-between; }
.bean-name { font-size:15px; font-weight:500; color:var(--text-primary); }
.bean-sub { font-size:12px; color:var(--text-secondary); margin-top:1px; }
.bean-actions { display:flex; gap:10px; align-items:center; }
.bean-scan { width:32px; height:32px; background:var(--accent-light); border-radius:10px; display:flex; align-items:center; justify-content:center; cursor:pointer; border:none; color:var(--accent); }
.bean-change { font-size:12px; font-weight:500; color:var(--accent); cursor:pointer; background:none; border:none; font-family:'DM Sans',sans-serif; }
.toggle-group { display:flex; gap:6px; }
.toggle-btn { flex:1; padding:9px 0; border:none; border-radius:12px; font-family:'DM Sans',sans-serif; font-size:13px; font-weight:500; cursor:pointer; transition:all 0.18s; background:var(--toggle-bg); color:var(--text-secondary); }
.toggle-btn.active { background:var(--toggle-active); color:#fff; }
.two-col { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
.stepper-card { background:var(--card); border-radius:20px; padding:12px 14px; box-shadow:var(--shadow); }
.stepper-label { font-size:11px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:8px; }
.stepper { display:flex; align-items:center; justify-content:space-between; }
.stepper-btn { width:36px; height:36px; border-radius:10px; border:none; background:var(--accent-light); color:var(--accent); font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.15s; user-select:none; }
.stepper-btn:active { transform:scale(0.9); background:var(--accent); color:white; }
.stepper-value { font-size:22px; font-weight:500; color:var(--text-primary); min-width:56px; text-align:center; }
.stepper-unit { font-size:12px; color:var(--text-secondary); font-weight:400; }
.puck-row { display:flex; align-items:center; justify-content:space-between; }
.puck-title { font-size:14px; font-weight:500; color:var(--text-primary); }
.puck-sub { font-size:11px; color:var(--text-secondary); margin-top:1px; }
.ios-toggle { width:51px; height:31px; background:#34C759; border-radius:16px; position:relative; cursor:pointer; transition:background 0.2s; flex-shrink:0; }
.ios-toggle::after { content:''; position:absolute; width:27px; height:27px; background:white; border-radius:14px; top:2px; left:22px; box-shadow:0 1px 4px rgba(0,0,0,0.2); transition:left 0.2s; }
.ios-toggle.off { background:var(--toggle-bg); }
.ios-toggle.off::after { left:2px; }
.notes-input { width:100%; border:none; background:transparent; font-family:'DM Sans',sans-serif; font-size:13px; color:var(--text-secondary); resize:none; outline:none; height:24px; }
.ratio-chip { background:var(--accent-light); color:var(--accent); font-size:11px; font-weight:600; padding:3px 8px; border-radius:6px; letter-spacing:0.03em; }
.save-btn { background:var(--text-primary); color:white; border:none; border-radius:18px; padding:16px; font-family:'DM Sans',sans-serif; font-size:16px; font-weight:600; cursor:pointer; width:100%; transition:all 0.2s; margin-top:auto; flex-shrink:0; }
.save-btn:active { opacity:0.8; }

/* ‚îÄ‚îÄ SCREEN 2: VERLAUF ‚îÄ‚îÄ */
.verlauf-content { flex:1; display:flex; flex-direction:column; padding:10px 20px 0; gap:10px; overflow:hidden; }
.filter-bar { display:flex; gap:7px; align-items:center; flex-shrink:0; }
.filter-scroll { display:flex; gap:6px; overflow-x:auto; flex:1; scrollbar-width:none; padding-bottom:2px; }
.filter-scroll::-webkit-scrollbar { display:none; }
.filter-chip { display:flex; align-items:center; gap:4px; background:var(--card); border:1.5px solid var(--border); border-radius:20px; padding:5px 11px; font-family:'DM Sans',sans-serif; font-size:12px; font-weight:500; color:var(--text-secondary); cursor:pointer; white-space:nowrap; transition:all 0.15s; flex-shrink:0; }
.filter-chip.active { background:var(--toggle-active); border-color:var(--toggle-active); color:white; }
.filter-btn { width:34px; height:34px; background:var(--card); border:none; border-radius:12px; cursor:pointer; box-shadow:var(--shadow); display:flex; align-items:center; justify-content:center; color:var(--text-secondary); flex-shrink:0; position:relative; }
.filter-badge { position:absolute; top:-3px; right:-3px; width:14px; height:14px; border-radius:7px; background:var(--accent); color:white; font-size:9px; font-weight:700; display:none; align-items:center; justify-content:center; }
.filter-badge.show { display:flex; }
.stats-strip { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; flex-shrink:0; }
.stat-card { background:var(--card); border-radius:16px; padding:11px 12px; box-shadow:var(--shadow); text-align:center; }
.stat-value { font-size:20px; font-weight:600; color:var(--text-primary); line-height:1; }
.stat-label { font-size:10px; color:var(--text-secondary); margin-top:3px; text-transform:uppercase; letter-spacing:0.05em; font-weight:600; }
.legend { display:flex; gap:10px; align-items:center; flex-shrink:0; }
.legend-item { display:flex; align-items:center; gap:5px; }
.legend-dot { width:8px; height:8px; border-radius:50%; }
.legend-dot.green { background:var(--green); } .legend-dot.yellow { background:var(--yellow); } .legend-dot.red { background:var(--red); }
.legend-text { font-size:10px; color:var(--text-secondary); font-weight:500; }
.table-wrap { flex:1; overflow-y:auto; background:var(--card); border-radius:20px; box-shadow:var(--shadow); scrollbar-width:none; }
.table-wrap::-webkit-scrollbar { display:none; }
.empty-state { display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; gap:8px; color:var(--text-secondary); }
.empty-state-icon { font-size:32px; opacity:0.4; }
.empty-state-text { font-size:13px; font-weight:500; }
table { width:100%; border-collapse:collapse; }
thead th { font-size:10px; font-weight:700; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.06em; padding:13px 14px 10px; text-align:left; position:sticky; top:0; background:var(--card); border-bottom:1px solid var(--border); }
thead th:nth-child(3) { text-align:right; } thead th:last-child { text-align:center; }
tbody tr { border-bottom:1px solid var(--border); cursor:pointer; transition:background 0.12s; }
tbody tr:last-child { border-bottom:none; } tbody tr:active { background:var(--bg); }
tbody td { padding:10px 14px; font-size:13px; color:var(--text-primary); vertical-align:middle; }
.td-date-day { font-size:13px; font-weight:500; } .td-date-sub { font-size:11px; color:var(--text-secondary); margin-top:1px; }
.td-bean-name { font-size:13px; font-weight:500; line-height:1.2; } .td-bean-type { font-size:11px; color:var(--text-secondary); margin-top:1px; }
.td-ratio { text-align:right; font-size:13px; font-weight:600; font-variant-numeric:tabular-nums; white-space:nowrap; }
.td-ampel { text-align:center; }
.ampel { display:inline-flex; width:26px; height:26px; border-radius:50%; align-items:center; justify-content:center; font-size:10px; font-weight:700; }
.ampel.green { background:var(--green-bg); color:var(--green); } .ampel.yellow { background:var(--yellow-bg); color:var(--yellow); } .ampel.red { background:var(--red-bg); color:var(--red); }

/* ‚îÄ‚îÄ SCREEN 3: DASHBOARD ‚îÄ‚îÄ */
.dash-content { flex:1; overflow-y:auto; padding:10px 20px 24px; scrollbar-width:none; }
.dash-content::-webkit-scrollbar { display:none; }
.kpi-row { display:grid; grid-template-columns:1fr 1fr 1fr; gap:8px; margin-bottom:12px; }
.kpi-card { background:var(--card); border-radius:16px; padding:12px 10px; box-shadow:var(--shadow); text-align:center; }
.kpi-value { font-size:22px; font-weight:700; color:var(--text-primary); line-height:1; }
.kpi-label { font-size:10px; color:var(--text-secondary); margin-top:3px; text-transform:uppercase; letter-spacing:0.05em; font-weight:600; }
.kpi-delta { font-size:10px; font-weight:600; margin-top:4px; }
.kpi-delta.up { color:var(--green); } .kpi-delta.down { color:var(--red); } .kpi-delta.neutral { color:var(--text-secondary); }
.dash-section { margin-bottom:14px; }
.dash-section-title { font-family:'DM Serif Display',serif; font-style:italic; font-size:17px; color:var(--text-primary); margin-bottom:10px; }
.chart-card { background:var(--card); border-radius:20px; padding:16px; box-shadow:var(--shadow); margin-bottom:10px; }
.chart-title { font-size:11px; font-weight:700; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.06em; margin-bottom:12px; }
.insight-card { border-radius:18px; padding:14px 16px; margin-bottom:8px; display:flex; gap:12px; align-items:flex-start; }
.insight-card.tip { background:var(--accent-light); }
.insight-card.warn { background:var(--yellow-bg); }
.insight-card.good { background:var(--green-bg); }
.insight-icon { font-size:20px; flex-shrink:0; margin-top:1px; }
.insight-title { font-size:13px; font-weight:600; color:var(--text-primary); margin-bottom:3px; }
.insight-text { font-size:12px; color:var(--text-secondary); line-height:1.5; }
.chart-svg { width:100%; overflow:visible; }
.donut-row { display:flex; align-items:center; gap:16px; }
.donut-legend { display:flex; flex-direction:column; gap:6px; }
.donut-legend-item { display:flex; align-items:center; gap:7px; }
.donut-legend-dot { width:10px; height:10px; border-radius:50%; flex-shrink:0; }
.donut-legend-label { font-size:12px; color:var(--text-secondary); }
.donut-legend-val { font-size:12px; font-weight:600; color:var(--text-primary); margin-left:4px; }
.bar-bg { fill:var(--bg); } .bar-green { fill:var(--green); } .bar-yellow { fill:var(--yellow); } .bar-red { fill:var(--red); } .bar-accent { fill:var(--accent); } .bar-neutral { fill:#D4CFC8; }
.chart-label { font-family:'DM Sans',sans-serif; font-size:9px; fill:var(--text-secondary); }
.chart-val { font-family:'DM Sans',sans-serif; font-size:10px; font-weight:600; fill:var(--text-primary); }
.chart-axis { stroke:var(--border); stroke-width:1; }
.line-path { fill:none; stroke-width:2.5; stroke-linecap:round; stroke-linejoin:round; }
.compare-row { display:flex; align-items:center; gap:8px; margin-bottom:8px; }
.compare-label { font-size:11px; font-weight:500; color:var(--text-secondary); width:64px; flex-shrink:0; text-align:right; }
.compare-track { flex:1; height:20px; background:var(--bg); border-radius:10px; overflow:hidden; position:relative; }
.compare-fill { height:100%; border-radius:10px; display:flex; align-items:center; padding-right:8px; justify-content:flex-end; }
.compare-fill-val { font-size:10px; font-weight:700; color:white; }
.compare-sub { font-size:10px; color:var(--text-secondary); width:28px; flex-shrink:0; }

/* ‚îÄ‚îÄ Sheets ‚îÄ‚îÄ */
.sheet-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.32); backdrop-filter:blur(4px); z-index:100; opacity:0; pointer-events:none; transition:opacity 0.25s; }
.sheet-overlay.open { opacity:1; pointer-events:all; }
.bottom-sheet { position:absolute; bottom:0; left:0; right:0; background:var(--card); border-radius:28px 28px 0 0; transform:translateY(100%); transition:transform 0.3s cubic-bezier(0.32,0.72,0,1); z-index:101; max-height:82%; display:flex; flex-direction:column; padding-bottom:env(safe-area-inset-bottom, 0px); }
.sheet-overlay.open .bottom-sheet { transform:translateY(0); }
.sheet-handle { width:36px; height:4px; background:var(--border); border-radius:2px; margin:12px auto 0; flex-shrink:0; }
.sheet-header { display:flex; justify-content:space-between; align-items:center; padding:14px 20px 0; flex-shrink:0; }
.sheet-title-text { font-family:'DM Serif Display',serif; font-style:italic; font-size:20px; color:var(--text-primary); }
.sheet-reset { font-size:12px; font-weight:500; color:var(--accent); background:none; border:none; cursor:pointer; font-family:'DM Sans',sans-serif; }
.sheet-body { overflow-y:auto; padding:14px 20px 36px; flex:1; scrollbar-width:none; }
.sheet-body::-webkit-scrollbar { display:none; }
.filter-section { margin-bottom:20px; }
.filter-section-label { font-size:11px; font-weight:700; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.07em; margin-bottom:10px; }
.chip-group { display:flex; flex-wrap:wrap; gap:7px; }
.opt-chip { padding:7px 14px; background:var(--bg); border:1.5px solid var(--border); border-radius:20px; font-family:'DM Sans',sans-serif; font-size:13px; font-weight:500; color:var(--text-secondary); cursor:pointer; transition:all 0.15s; }
.opt-chip.active { background:var(--toggle-active); border-color:var(--toggle-active); color:white; }
.opt-chip.green-chip.active { background:var(--green); border-color:var(--green); }
.opt-chip.yellow-chip.active { background:var(--yellow); border-color:var(--yellow); }
.opt-chip.red-chip.active { background:var(--red); border-color:var(--red); }
.apply-btn { width:100%; padding:14px; background:var(--text-primary); color:white; border:none; border-radius:16px; font-family:'DM Sans',sans-serif; font-size:15px; font-weight:600; cursor:pointer; margin-top:4px; }
.bean-sheet-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.32); backdrop-filter:blur(4px); z-index:100; opacity:0; pointer-events:none; transition:opacity 0.25s; }
.bean-sheet-overlay.open { opacity:1; pointer-events:all; }
.bean-sheet { position:absolute; bottom:0; left:0; right:0; background:var(--card); border-radius:28px 28px 0 0; padding:0 0 env(safe-area-inset-bottom, 20px); transform:translateY(100%); transition:transform 0.3s cubic-bezier(0.32,0.72,0,1); z-index:101; }
.bean-sheet-overlay.open .bean-sheet { transform:translateY(0); }
.sheet-actions { display:flex; gap:8px; padding:0 20px 14px; }
.sheet-action-btn { flex:1; padding:12px 0; border-radius:14px; border:none; font-family:'DM Sans',sans-serif; font-size:13px; font-weight:500; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:6px; }
.btn-scan { background:var(--accent); color:white; } .btn-new { background:var(--toggle-bg); color:var(--text-secondary); }
.sheet-divider { height:1px; background:var(--border); margin:0 20px 12px; }
.sheet-section-label-sm { font-size:11px; font-weight:600; color:var(--text-secondary); text-transform:uppercase; letter-spacing:0.06em; padding:0 20px 10px; }
.bean-list { padding:0 12px 8px; }
.bean-item { display:flex; align-items:center; padding:10px 8px; border-radius:14px; cursor:pointer; transition:background 0.15s; gap:12px; }
.bean-item:active { background:var(--bg); } .bean-item.selected { background:var(--accent-light); }
.bean-dot { width:36px; height:36px; border-radius:10px; background:var(--accent-light); display:flex; align-items:center; justify-content:center; font-size:17px; flex-shrink:0; }
.bean-item-name { font-size:14px; font-weight:500; color:var(--text-primary); }
.bean-item-sub { font-size:12px; color:var(--text-secondary); margin-top:1px; }
.bean-check { margin-left:auto; color:var(--accent); font-size:16px; font-weight:700; }

/* ‚îÄ‚îÄ "Neue Bohne" Formular ‚îÄ‚îÄ */
.new-bean-form { display:none; padding:0 20px 8px; flex-direction:column; gap:10px; }
.new-bean-form.open { display:flex; }
.form-input { width:100%; border:1.5px solid var(--border); background:var(--bg); border-radius:14px; padding:11px 14px; font-family:'DM Sans',sans-serif; font-size:14px; color:var(--text-primary); outline:none; transition:border-color 0.15s; }
.form-input:focus { border-color:var(--accent); }
.add-bean-btn { background:var(--accent); color:white; border:none; border-radius:14px; padding:13px; font-family:'DM Sans',sans-serif; font-size:14px; font-weight:600; cursor:pointer; }

/* ‚îÄ‚îÄ "Shot Detail" Overlay ‚îÄ‚îÄ */
.detail-overlay { position:absolute; inset:0; background:rgba(0,0,0,0.32); backdrop-filter:blur(4px); z-index:100; opacity:0; pointer-events:none; transition:opacity 0.25s; }
.detail-overlay.open { opacity:1; pointer-events:all; }
.detail-sheet { position:absolute; bottom:0; left:0; right:0; background:var(--card); border-radius:28px 28px 0 0; padding:0 0 env(safe-area-inset-bottom, 20px); transform:translateY(100%); transition:transform 0.3s cubic-bezier(0.32,0.72,0,1); z-index:101; }
.detail-overlay.open .detail-sheet { transform:translateY(0); }
.detail-row { display:flex; justify-content:space-between; align-items:center; padding:11px 0; border-bottom:1px solid var(--border); }
.detail-row:last-child { border-bottom:none; }
.detail-key { font-size:13px; color:var(--text-secondary); }
.detail-val { font-size:13px; font-weight:600; color:var(--text-primary); }

/* ‚îÄ‚îÄ Toast-Notification ‚îÄ‚îÄ */
.toast { position:absolute; bottom:calc(env(safe-area-inset-bottom, 20px) + 24px); left:50%; transform:translateX(-50%) translateY(20px); background:var(--text-primary); color:white; padding:12px 24px; border-radius:24px; font-size:14px; font-weight:600; opacity:0; transition:all 0.3s; z-index:200; white-space:nowrap; pointer-events:none; }
.toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
</style>
</head>
<body>
<div class="app-wrapper">
  <!-- Safe area f√ºr Dynamic Island / Notch -->
  <div class="safe-top"></div>

  <!-- ‚ïê‚ïê SCREEN 1: SHOT LOG ‚ïê‚ïê -->
  <div class="screen active" id="screen-log">
    <div class="top-bar">
      <div class="top-bar-left"></div>
      <div class="top-bar-center"><h1>Shot Log</h1><p id="current-date">Di, 17. Feb ¬∑ 09:41</p></div>
      <div class="top-bar-right"><button class="nav-btn" id="to-verlauf-btn">Verlauf ‚Üí</button></div>
    </div>
    <div class="app-content">
      <div class="card">
        <div class="card-label">Bohne</div>
        <div class="bean-row">
          <div><div class="bean-name" id="selected-bean-name">Gardelli ‚Äî Specialty</div><div class="bean-sub" id="selected-bean-sub">Ethiopia Guji ¬∑ Hell ger√∂stet</div></div>
          <div class="bean-actions">
            <button class="bean-scan" id="scan-btn" title="Barcode scannen">
              <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round"><rect x="3" y="3" width="5" height="5"/><rect x="16" y="3" width="5" height="5"/><rect x="3" y="16" width="5" height="5"/><line x1="16" y1="16" x2="21" y2="16"/><line x1="19" y1="16" x2="19" y2="21"/><line x1="16" y1="19" x2="16" y2="21"/></svg>
            </button>
            <button class="bean-change" id="open-sheet-btn">√Ñndern</button>
          </div>
        </div>
      </div>
      <div class="two-col">
        <div class="card">
          <div class="card-label">Bezug</div>
          <div class="toggle-group" id="type-toggle">
            <button class="toggle-btn" data-val="Single">Single</button>
            <button class="toggle-btn active" data-val="Double">Double</button>
          </div>
        </div>
        <div class="card">
          <div class="card-label">Siebtr√§ger</div>
          <div class="toggle-group" id="basket-toggle">
            <button class="toggle-btn" data-val="Normal">Normal</button>
            <button class="toggle-btn active" data-val="Bodenlos">Bodenlos</button>
          </div>
        </div>
      </div>
      <div class="two-col">
        <div class="stepper-card">
          <div class="stepper-label">Dosis</div>
          <div class="stepper" id="dosis-stepper" data-value="18" data-step="0.5" data-unit="g" data-dec="1">
            <button class="stepper-btn">‚àí</button>
            <span class="stepper-value">18<span class="stepper-unit">g</span></span>
            <button class="stepper-btn">+</button>
          </div>
        </div>
        <div class="stepper-card">
          <div class="stepper-label">Durchlauf</div>
          <div class="stepper" id="zeit-stepper" data-value="28" data-step="1" data-unit="s" data-dec="0">
            <button class="stepper-btn">‚àí</button>
            <span class="stepper-value">28<span class="stepper-unit">s</span></span>
            <button class="stepper-btn">+</button>
          </div>
        </div>
      </div>
      <div class="stepper-card">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
          <div class="stepper-label" style="margin-bottom:0">Espresso</div>
          <span class="ratio-chip" id="ratio-chip">1 : 2.0 Ratio</span>
        </div>
        <div class="stepper" id="espresso-stepper" data-value="36" data-step="0.5" data-unit="g" data-dec="1">
          <button class="stepper-btn">‚àí</button>
          <span class="stepper-value">36<span class="stepper-unit">g</span></span>
          <button class="stepper-btn">+</button>
        </div>
      </div>
      <div class="card">
        <div class="puck-row">
          <div><div class="puck-title">Puck Screen</div><div class="puck-sub" id="puck-sub">Verwendet</div></div>
          <div class="ios-toggle" id="puck-toggle"></div>
        </div>
      </div>
      <div class="card">
        <div class="card-label">Notiz</div>
        <textarea class="notes-input" id="notes-input" placeholder="Frucht, S√§ure, S√º√üe ‚Ä¶ (optional)"></textarea>
      </div>
      <button class="save-btn" id="save-btn">Shot speichern</button>
    </div>
    <div class="safe-bottom-pad"></div>
  </div>

  <!-- ‚ïê‚ïê SCREEN 2: VERLAUF ‚ïê‚ïê -->
  <div class="screen" id="screen-verlauf">
    <div class="top-bar">
      <div class="top-bar-left"><button class="nav-btn" id="back-from-verlauf">‚Üê Zur√ºck</button></div>
      <div class="top-bar-center"><h1>Verlauf</h1><p id="verlauf-sub">0 Shots</p></div>
      <div class="top-bar-right"><button class="nav-btn" id="to-dashboard-btn">Dashboard ‚Üí</button></div>
    </div>
    <div class="verlauf-content">
      <div class="filter-bar">
        <div class="filter-scroll" id="active-filter-chips">
          <span style="font-size:12px;color:var(--text-secondary);align-self:center;white-space:nowrap;">Alle Shots</span>
        </div>
        <button class="filter-btn" id="open-filter-btn">
          <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"><line x1="4" y1="6" x2="20" y2="6"/><line x1="8" y1="12" x2="16" y2="12"/><line x1="11" y1="18" x2="13" y2="18"/></svg>
          <div class="filter-badge" id="filter-badge">0</div>
        </button>
      </div>
      <div class="stats-strip">
        <div class="stat-card"><div class="stat-value" id="stat-total">0</div><div class="stat-label">Shots</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-avg-ratio">‚Äî</div><div class="stat-label">√ò Ratio</div></div>
        <div class="stat-card"><div class="stat-value" id="stat-green-pct">‚Äî</div><div class="stat-label">üü¢ Quote</div></div>
      </div>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot green"></div><span class="legend-text">1:1.8‚Äì2.8</span></div>
        <div class="legend-item"><div class="legend-dot yellow"></div><span class="legend-text">1:1.4‚Äì1.79 / 2.81‚Äì3.0</span></div>
        <div class="legend-item"><div class="legend-dot red"></div><span class="legend-text">Au√üerhalb</span></div>
      </div>
      <div class="table-wrap">
        <table><thead><tr><th>Datum</th><th>Bohne</th><th style="text-align:right">Ratio</th><th style="text-align:center">‚¨§</th></tr></thead>
        <tbody id="shot-table-body"></tbody></table>
      </div>
    </div>
    <div class="safe-bottom-pad"></div>
  </div>

  <!-- ‚ïê‚ïê SCREEN 3: DASHBOARD ‚ïê‚ïê -->
  <div class="screen" id="screen-dashboard">
    <div class="top-bar">
      <div class="top-bar-left"><button class="nav-btn" id="back-from-dashboard">‚Üê Zur√ºck</button></div>
      <div class="top-bar-center"><h1>Dashboard</h1><p id="dash-subtitle">Lade...</p></div>
      <div class="top-bar-right"></div>
    </div>
    <div class="dash-content" id="dash-content"></div>
    <div class="safe-bottom-pad"></div>
  </div>

  <!-- ‚îÄ‚îÄ Filter Sheet ‚îÄ‚îÄ -->
  <div class="sheet-overlay" id="filter-overlay">
    <div class="bottom-sheet">
      <div class="sheet-handle"></div>
      <div class="sheet-header">
        <span class="sheet-title-text">Filtern</span>
        <button class="sheet-reset" id="reset-filters-btn">Zur√ºcksetzen</button>
      </div>
      <div class="sheet-body">
        <div class="filter-section"><div class="filter-section-label">Zeitraum</div><div class="chip-group" id="time-filter-group"><div class="opt-chip" data-filter="time" data-val="today">Heute</div><div class="opt-chip" data-filter="time" data-val="week">Diese Woche</div><div class="opt-chip" data-filter="time" data-val="kw">KW <span id="kw-label"></span></div><div class="opt-chip" data-filter="time" data-val="month">Dieser Monat</div><div class="opt-chip" data-filter="time" data-val="q1">Q1</div><div class="opt-chip" data-filter="time" data-val="q2">Q2</div><div class="opt-chip" data-filter="time" data-val="q3">Q3</div><div class="opt-chip" data-filter="time" data-val="q4">Q4</div><div class="opt-chip" data-filter="time" data-val="year">Dieses Jahr</div></div></div>
        <div class="filter-section"><div class="filter-section-label">Wertung</div><div class="chip-group"><div class="opt-chip green-chip" data-filter="ampel" data-val="green">üü¢ Gr√ºn</div><div class="opt-chip yellow-chip" data-filter="ampel" data-val="yellow">üü° Gelb</div><div class="opt-chip red-chip" data-filter="ampel" data-val="red">üî¥ Rot</div></div></div>
        <div class="filter-section"><div class="filter-section-label">Bezug</div><div class="chip-group"><div class="opt-chip" data-filter="type" data-val="Single">Single</div><div class="opt-chip" data-filter="type" data-val="Double">Double</div></div></div>
        <div class="filter-section"><div class="filter-section-label">Siebtr√§ger</div><div class="chip-group"><div class="opt-chip" data-filter="basket" data-val="Normal">Normal</div><div class="opt-chip" data-filter="basket" data-val="Bodenlos">Bodenlos</div></div></div>
        <div class="filter-section"><div class="filter-section-label">Bohne</div><div class="chip-group" id="bean-filter-group"></div></div>
        <div class="filter-section"><div class="filter-section-label">Puck Screen</div><div class="chip-group"><div class="opt-chip" data-filter="puck" data-val="true">Verwendet</div><div class="opt-chip" data-filter="puck" data-val="false">Nicht verwendet</div></div></div>
        <button class="apply-btn" id="apply-filter-btn">Anwenden</button>
      </div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Bean Sheet ‚îÄ‚îÄ -->
  <div class="bean-sheet-overlay" id="bean-sheet-overlay">
    <div class="bean-sheet">
      <div class="sheet-handle"></div>
      <div style="font-family:'DM Serif Display',serif;font-style:italic;font-size:20px;color:var(--text-primary);padding:14px 20px 14px;">Bohne w√§hlen</div>
      <div class="sheet-actions">
        <button class="sheet-action-btn btn-scan" id="scan-action-btn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><rect x="3" y="3" width="5" height="5"/><rect x="16" y="3" width="5" height="5"/><rect x="3" y="16" width="5" height="5"/><line x1="16" y1="16" x2="21" y2="16"/><line x1="19" y1="16" x2="19" y2="21"/><line x1="16" y1="19" x2="16" y2="21"/></svg>
          Barcode scannen
        </button>
        <button class="sheet-action-btn btn-new" id="new-bean-btn">Ôºã Neue Bohne</button>
      </div>
      <!-- Neue Bohne Formular -->
      <div class="new-bean-form" id="new-bean-form">
        <input class="form-input" id="new-bean-name" placeholder="Name (z.B. Gardelli)" maxlength="40">
        <input class="form-input" id="new-bean-sub" placeholder="Herkunft ¬∑ R√∂stung (optional)" maxlength="60">
        <button class="add-bean-btn" id="add-bean-confirm">Bohne hinzuf√ºgen</button>
      </div>
      <div class="sheet-divider"></div>
      <div class="sheet-section-label-sm">Zuletzt verwendet</div>
      <div class="bean-list" id="bean-list"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Shot Detail Sheet ‚îÄ‚îÄ -->
  <div class="detail-overlay" id="detail-overlay">
    <div class="detail-sheet">
      <div class="sheet-handle"></div>
      <div style="font-family:'DM Serif Display',serif;font-style:italic;font-size:20px;color:var(--text-primary);padding:14px 20px 10px;display:flex;justify-content:space-between;align-items:center;">
        Shot Details
        <button id="delete-shot-btn" style="background:var(--red-bg);color:var(--red);border:none;border-radius:10px;padding:7px 12px;font-family:'DM Sans',sans-serif;font-size:12px;font-weight:600;cursor:pointer;">üóë L√∂schen</button>
      </div>
      <div id="detail-content" style="padding:0 20px 20px;"></div>
    </div>
  </div>

  <!-- ‚îÄ‚îÄ Toast ‚îÄ‚îÄ -->
  <div class="toast" id="toast"></div>
</div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DATENPERSISTENZ ‚Äî localStorage
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const STORAGE_KEY_SHOTS = 'espresso_shots_v1';
const STORAGE_KEY_BEANS = 'espresso_beans_v1';

// Demo-Daten (nur beim allerersten Start geladen)
const DEMO_SHOTS = [
  {id:'d1', date:new Date(2026,1,17,9,41).toISOString(),  bean:"Gardelli",      beanSub:"Ethiopia Guji", type:"Double",basket:"Bodenlos",puck:true, dosis:18,  espresso:36, ratio:2.0,  zeit:27, note:""},
  {id:'d2', date:new Date(2026,1,17,7,12).toISOString(),  bean:"Gardelli",      beanSub:"Ethiopia Guji", type:"Double",basket:"Bodenlos",puck:true, dosis:18,  espresso:38, ratio:2.11, zeit:29, note:"Sehr fruchtig"},
  {id:'d3', date:new Date(2026,1,16,8,5).toISOString(),   bean:"The Barn",      beanSub:"Colombia",      type:"Single",basket:"Normal",  puck:false,dosis:9,   espresso:22, ratio:2.44, zeit:26, note:""},
  {id:'d4', date:new Date(2026,1,15,9,30).toISOString(),  bean:"Five Elephant", beanSub:"Kenya Kiambu",  type:"Double",basket:"Bodenlos",puck:true, dosis:18,  espresso:54, ratio:3.0,  zeit:34, note:"L√§uft zu schnell"},
  {id:'d5', date:new Date(2026,1,15,7,55).toISOString(),  bean:"Gardelli",      beanSub:"Ethiopia Guji", type:"Double",basket:"Bodenlos",puck:true, dosis:18,  espresso:32, ratio:1.78, zeit:23, note:""},
  {id:'d6', date:new Date(2026,1,14,9,10).toISOString(),  bean:"Bonanza",       beanSub:"Guatemala",     type:"Double",basket:"Normal",  puck:false,dosis:17,  espresso:25, ratio:1.47, zeit:19, note:"Mahlgrad zu grob"},
  {id:'d7', date:new Date(2026,1,13,8,22).toISOString(),  bean:"The Barn",      beanSub:"Colombia",      type:"Double",basket:"Normal",  puck:true, dosis:18,  espresso:37, ratio:2.06, zeit:28, note:""},
  {id:'d8', date:new Date(2026,1,12,9,0).toISOString(),   bean:"Gardelli",      beanSub:"Ethiopia Guji", type:"Double",basket:"Bodenlos",puck:true, dosis:18.5,espresso:40, ratio:2.16, zeit:30, note:""},
  {id:'d9', date:new Date(2026,1,11,7,45).toISOString(),  bean:"Five Elephant", beanSub:"Kenya Kiambu",  type:"Single",basket:"Normal",  puck:false,dosis:9,   espresso:10, ratio:1.11, zeit:15, note:"Falsch dosiert"},
  {id:'d10',date:new Date(2026,1,10,8,30).toISOString(),  bean:"Gardelli",      beanSub:"Ethiopia Guji", type:"Double",basket:"Bodenlos",puck:true, dosis:18,  espresso:36, ratio:2.0,  zeit:27, note:""},
  {id:'d11',date:new Date(2026,1,9,9,15).toISOString(),   bean:"The Barn",      beanSub:"Colombia",      type:"Double",basket:"Normal",  puck:true, dosis:18,  espresso:48, ratio:2.67, zeit:31, note:""},
  {id:'d12',date:new Date(2026,1,8,8,0).toISOString(),    bean:"Bonanza",       beanSub:"Guatemala",     type:"Double",basket:"Normal",  puck:false,dosis:17,  espresso:58, ratio:3.41, zeit:38, note:"Viel zu lang"},
];

const DEMO_BEANS = [
  {id:'b1', name:"Gardelli",      sub:"Ethiopia Guji ¬∑ Hell",     emoji:"ü´ò"},
  {id:'b2', name:"The Barn",      sub:"Colombia ¬∑ Mittel",        emoji:"‚òï"},
  {id:'b3', name:"Five Elephant", sub:"Kenya ¬∑ Hell",             emoji:"üåø"},
  {id:'b4', name:"Bonanza",       sub:"Guatemala ¬∑ Naturell",     emoji:"üü§"},
];

function loadShots() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY_SHOTS);
    if (raw) {
      const arr = JSON.parse(raw);
      return arr.map(s => ({...s, date: new Date(s.date)}));
    }
  } catch(e) {}
  // Erster Start: Demo-Daten speichern
  saveShots(DEMO_SHOTS.map(s => ({...s})));
  return DEMO_SHOTS.map(s => ({...s, date: new Date(s.date)}));
}

function saveShots(arr) {
  const toStore = arr.map(s => ({
    ...s,
    date: s.date instanceof Date ? s.date.toISOString() : s.date
  }));
  localStorage.setItem(STORAGE_KEY_SHOTS, JSON.stringify(toStore));
}

function loadBeans() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY_BEANS);
    if (raw) return JSON.parse(raw);
  } catch(e) {}
  saveBeans(DEMO_BEANS);
  return [...DEMO_BEANS];
}

function saveBeans(arr) {
  localStorage.setItem(STORAGE_KEY_BEANS, JSON.stringify(arr));
}

// ‚îÄ‚îÄ Daten laden ‚îÄ‚îÄ
let shots = loadShots();
let beans = loadBeans();

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HILFSFUNKTIONEN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getAmpel(r) {
  if (r >= 1.8 && r <= 2.8) return 'green';
  if ((r >= 1.4 && r < 1.8) || (r > 2.8 && r <= 3.0)) return 'yellow';
  return 'red';
}
const DAYS = ['So','Mo','Di','Mi','Do','Fr','Sa'];
const MONTHS = ['Jan','Feb','M√§r','Apr','Mai','Jun','Jul','Aug','Sep','Okt','Nov','Dez'];
function fmtDate(d) { return `${DAYS[d.getDay()]}, ${d.getDate()}. ${MONTHS[d.getMonth()]}`; }
function fmtTime(d) { return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0'); }
function getKW(d) { const j = new Date(d.getFullYear(),0,1); return Math.ceil(((d-j)/86400000+j.getDay()+1)/7); }
function genId() { return Date.now().toString(36) + Math.random().toString(36).slice(2,6); }

function showToast(msg, duration=1800) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STATUS BAR ‚Äî Echte Uhrzeit
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateDateTime() {
  const now = new Date();
  const dateStr = `${DAYS[now.getDay()]}, ${now.getDate()}. ${MONTHS[now.getMonth()]} ¬∑ ${fmtTime(now)}`;
  document.getElementById('current-date').textContent = dateStr;
}
updateDateTime();
setInterval(updateDateTime, 30000);

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NAVIGATION
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

document.getElementById('to-verlauf-btn').addEventListener('click', () => { renderVerlauf(); showScreen('screen-verlauf'); });
document.getElementById('back-from-verlauf').addEventListener('click', () => { loadLastShotDefaults(); showScreen('screen-log'); });
document.getElementById('to-dashboard-btn').addEventListener('click', () => { buildDashboard(); showScreen('screen-dashboard'); });
document.getElementById('back-from-dashboard').addEventListener('click', () => showScreen('screen-verlauf'));

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STEPPER-LOGIK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function getStepperVal(id) {
  const el = document.querySelector(`#${id} .stepper-value`);
  return parseFloat(el.textContent);
}

function setStepperVal(id, val) {
  const stepper = document.getElementById(id);
  const dec = parseInt(stepper.dataset.dec);
  const unit = stepper.dataset.unit;
  const el = stepper.querySelector('.stepper-value');
  el.innerHTML = (dec > 0 ? val.toFixed(dec) : val) + `<span class="stepper-unit">${unit}</span>`;
}

function updateRatio() {
  const d = getStepperVal('dosis-stepper');
  const e = getStepperVal('espresso-stepper');
  if (d > 0) document.getElementById('ratio-chip').textContent = '1 : ' + (e/d).toFixed(2) + ' Ratio';
}

document.querySelectorAll('.stepper').forEach(s => {
  let val = parseFloat(s.dataset.value);
  const step = parseFloat(s.dataset.step);
  const unit = s.dataset.unit;
  const dec = parseInt(s.dataset.dec);
  const el = s.querySelector('.stepper-value');
  const render = () => {
    el.innerHTML = (dec > 0 ? val.toFixed(dec) : val) + `<span class="stepper-unit">${unit}</span>`;
    updateRatio();
  };
  s.querySelector('.stepper-btn:first-child').addEventListener('click', () => { val = parseFloat(Math.max(0, val - step).toFixed(dec)); render(); });
  s.querySelector('.stepper-btn:last-child').addEventListener('click', () => { val = parseFloat((val + step).toFixed(dec)); render(); });
  // Langer Druck (hold) f√ºr schnelles √Ñndern
  let holdTimer, holdInterval;
  s.querySelectorAll('.stepper-btn').forEach(btn => {
    const isPlus = btn === s.querySelector('.stepper-btn:last-child');
    btn.addEventListener('pointerdown', () => {
      holdTimer = setTimeout(() => {
        holdInterval = setInterval(() => {
          val = isPlus ? parseFloat((val + step).toFixed(dec)) : parseFloat(Math.max(0, val - step).toFixed(dec));
          render();
        }, 100);
      }, 500);
    });
    btn.addEventListener('pointerup', () => { clearTimeout(holdTimer); clearInterval(holdInterval); });
    btn.addEventListener('pointerleave', () => { clearTimeout(holdTimer); clearInterval(holdInterval); });
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TOGGLE GROUPS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.querySelectorAll('.toggle-group').forEach(group => {
  group.querySelectorAll('.toggle-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      group.querySelectorAll('.toggle-btn').forEach(b => b.classList.remove('active'));
      btn.classList.add('active');
    });
  });
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  PUCK TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('puck-toggle').addEventListener('click', function() {
  this.classList.toggle('off');
  document.getElementById('puck-sub').textContent = this.classList.contains('off') ? 'Nicht verwendet' : 'Verwendet';
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  LAST SHOT DEFAULTS laden
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function loadLastShotDefaults() {
  if (shots.length === 0) return;
  const last = shots[0];
  // Stepper-Werte
  setStepperVal('dosis-stepper', last.dosis);
  setStepperVal('zeit-stepper', last.zeit || 28);
  setStepperVal('espresso-stepper', last.espresso);
  updateRatio();
  // Toggles
  document.querySelectorAll('#type-toggle .toggle-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.val === last.type);
  });
  document.querySelectorAll('#basket-toggle .toggle-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.val === last.basket);
  });
  // Puck
  const puckToggle = document.getElementById('puck-toggle');
  puckToggle.classList.toggle('off', !last.puck);
  document.getElementById('puck-sub').textContent = last.puck ? 'Verwendet' : 'Nicht verwendet';
  // Bohne
  document.getElementById('selected-bean-name').textContent = last.bean;
  document.getElementById('selected-bean-sub').textContent = last.beanSub;
  // Notiz leeren
  document.getElementById('notes-input').value = '';
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SHOT SPEICHERN
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
document.getElementById('save-btn').addEventListener('click', () => {
  const d = getStepperVal('dosis-stepper');
  const e = getStepperVal('espresso-stepper');
  const z = getStepperVal('zeit-stepper');
  const ratio = d > 0 ? parseFloat((e/d).toFixed(2)) : 0;

  const typeActive = document.querySelector('#type-toggle .toggle-btn.active');
  const basketActive = document.querySelector('#basket-toggle .toggle-btn.active');
  const puck = !document.getElementById('puck-toggle').classList.contains('off');
  const note = document.getElementById('notes-input').value.trim();

  const newShot = {
    id: genId(),
    date: new Date(),
    bean: document.getElementById('selected-bean-name').textContent,
    beanSub: document.getElementById('selected-bean-sub').textContent,
    type: typeActive ? typeActive.dataset.val : 'Double',
    basket: basketActive ? basketActive.dataset.val : 'Bodenlos',
    puck,
    dosis: d,
    espresso: e,
    ratio,
    zeit: z,
    note
  };

  shots.unshift(newShot);
  saveShots(shots);

  // Notiz leeren
  document.getElementById('notes-input').value = '';

  showToast('‚úì Shot gespeichert');

  // Button-Feedback
  const btn = document.getElementById('save-btn');
  btn.textContent = '‚úì Gespeichert';
  btn.style.background = 'var(--green)';
  setTimeout(() => { btn.textContent = 'Shot speichern'; btn.style.background = ''; }, 1500);
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  VERLAUF
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeFilters = {};

function matchesFilters(s) {
  const now = new Date();
  const sDate = s.date instanceof Date ? s.date : new Date(s.date);
  if (activeFilters.time) {
    const v = activeFilters.time;
    const nowDateStr = now.toDateString();
    if (v === 'today' && sDate.toDateString() !== nowDateStr) return false;
    if (v === 'week' && ((now - sDate)/86400000 < 0 || (now - sDate)/86400000 > 7)) return false;
    if (v === 'kw' && getKW(sDate) !== getKW(now)) return false;
    if (v === 'month' && (sDate.getMonth() !== now.getMonth() || sDate.getFullYear() !== now.getFullYear())) return false;
    if (v === 'year' && sDate.getFullYear() !== now.getFullYear()) return false;
    if (v === 'q1' && sDate.getMonth() > 2) return false;
    if (v === 'q2' && (sDate.getMonth() < 3 || sDate.getMonth() > 5)) return false;
    if (v === 'q3' && (sDate.getMonth() < 6 || sDate.getMonth() > 8)) return false;
    if (v === 'q4' && sDate.getMonth() < 9) return false;
  }
  if (activeFilters.ampel && getAmpel(s.ratio) !== activeFilters.ampel) return false;
  if (activeFilters.type && s.type !== activeFilters.type) return false;
  if (activeFilters.basket && s.basket !== activeFilters.basket) return false;
  if (activeFilters.bean && s.bean !== activeFilters.bean) return false;
  if (activeFilters.puck !== undefined && s.puck !== activeFilters.puck) return false;
  return true;
}

let currentDetailShotId = null;

function renderVerlauf() {
  const filtered = shots.filter(matchesFilters);
  const tbody = document.getElementById('shot-table-body');

  if (filtered.length === 0) {
    tbody.innerHTML = `<tr><td colspan="4"><div class="empty-state"><div class="empty-state-icon">‚òï</div><div class="empty-state-text">Keine Shots gefunden</div></div></td></tr>`;
  } else {
    tbody.innerHTML = filtered.map(s => {
      const cls = getAmpel(s.ratio);
      const d = s.date instanceof Date ? s.date : new Date(s.date);
      return `<tr data-id="${s.id}">
        <td><div class="td-date-day">${fmtDate(d)}</div><div class="td-date-sub">${fmtTime(d)}</div></td>
        <td><div class="td-bean-name">${s.bean}</div><div class="td-bean-type">${s.type} ¬∑ ${s.beanSub}</div></td>
        <td class="td-ratio">1 : ${s.ratio.toFixed(2)}</td>
        <td class="td-ampel"><span class="ampel ${cls}">‚óè</span></td>
      </tr>`;
    }).join('');

    // Shot-Detail bei Tap
    tbody.querySelectorAll('tr[data-id]').forEach(row => {
      row.addEventListener('click', () => openDetailSheet(row.dataset.id));
    });
  }

  const total = filtered.length;
  if (total > 0) {
    const avg = filtered.reduce((a,s) => a + s.ratio, 0) / total;
    const greenCt = filtered.filter(s => getAmpel(s.ratio) === 'green').length;
    document.getElementById('stat-total').textContent = total;
    document.getElementById('stat-avg-ratio').textContent = '1:' + avg.toFixed(1);
    document.getElementById('stat-green-pct').textContent = Math.round(greenCt/total*100) + '%';
  } else {
    document.getElementById('stat-total').textContent = '0';
    document.getElementById('stat-avg-ratio').textContent = '‚Äî';
    document.getElementById('stat-green-pct').textContent = '‚Äî';
  }
  document.getElementById('verlauf-sub').textContent = `${total} Shot${total !== 1 ? 's' : ''}`;

  // Active-Filter-Chips
  const bar = document.getElementById('active-filter-chips');
  const labels = {
    time: {today:'Heute',week:'Diese Woche',kw:'Akt. KW',month:'Dieser Monat',q1:'Q1',q2:'Q2',q3:'Q3',q4:'Q4',year:'Dieses Jahr'},
    ampel: {green:'üü¢ Gr√ºn',yellow:'üü° Gelb',red:'üî¥ Rot'},
    type: v => v, basket: v => v, bean: v => v,
    puck: {true:'Puck ‚úì', false:'Puck ‚úó'}
  };
  const chips = Object.entries(activeFilters).map(([k,v]) => {
    const lbl = typeof labels[k] === 'function' ? labels[k](v) : (labels[k]?.[String(v)] || v);
    return `<span class="filter-chip active" data-remove="${k}">${lbl} ‚úï</span>`;
  });
  bar.innerHTML = chips.length > 0 ? chips.join('') : '<span style="font-size:12px;color:var(--text-secondary);align-self:center;white-space:nowrap;">Alle Shots</span>';
  bar.querySelectorAll('.filter-chip[data-remove]').forEach(c => {
    c.addEventListener('click', () => { delete activeFilters[c.dataset.remove]; renderVerlauf(); updateFilterBadge(); });
  });
  updateFilterBadge();
}

function updateFilterBadge() {
  const cnt = Object.keys(activeFilters).length;
  const badge = document.getElementById('filter-badge');
  badge.textContent = cnt;
  badge.classList.toggle('show', cnt > 0);
}

// ‚îÄ‚îÄ Shot Detail Sheet ‚îÄ‚îÄ
function openDetailSheet(id) {
  const shot = shots.find(s => s.id === id);
  if (!shot) return;
  currentDetailShotId = id;
  const d = shot.date instanceof Date ? shot.date : new Date(shot.date);
  const ampelCls = getAmpel(shot.ratio);
  const ampelLabel = {green:'üü¢ Gr√ºn', yellow:'üü° Gelb', red:'üî¥ Rot'}[ampelCls];

  document.getElementById('detail-content').innerHTML = `
    <div class="detail-row"><span class="detail-key">Datum</span><span class="detail-val">${fmtDate(d)}, ${fmtTime(d)}</span></div>
    <div class="detail-row"><span class="detail-key">Bohne</span><span class="detail-val">${shot.bean}</span></div>
    <div class="detail-row"><span class="detail-key">Herkunft</span><span class="detail-val">${shot.beanSub}</span></div>
    <div class="detail-row"><span class="detail-key">Bezug</span><span class="detail-val">${shot.type}</span></div>
    <div class="detail-row"><span class="detail-key">Siebtr√§ger</span><span class="detail-val">${shot.basket}</span></div>
    <div class="detail-row"><span class="detail-key">Dosis</span><span class="detail-val">${shot.dosis}g</span></div>
    <div class="detail-row"><span class="detail-key">Espresso</span><span class="detail-val">${shot.espresso}g</span></div>
    <div class="detail-row"><span class="detail-key">Brew Ratio</span><span class="detail-val">1 : ${shot.ratio.toFixed(2)}</span></div>
    <div class="detail-row"><span class="detail-key">Durchlaufzeit</span><span class="detail-val">${shot.zeit}s</span></div>
    <div class="detail-row"><span class="detail-key">Puck Screen</span><span class="detail-val">${shot.puck ? '‚úì Ja' : '‚úó Nein'}</span></div>
    <div class="detail-row"><span class="detail-key">Wertung</span><span class="detail-val">${ampelLabel}</span></div>
    ${shot.note ? `<div class="detail-row"><span class="detail-key">Notiz</span><span class="detail-val">${shot.note}</span></div>` : ''}
  `;
  document.getElementById('detail-overlay').classList.add('open');
}

document.getElementById('detail-overlay').addEventListener('click', e => {
  if (e.target === document.getElementById('detail-overlay')) {
    document.getElementById('detail-overlay').classList.remove('open');
  }
});

document.getElementById('delete-shot-btn').addEventListener('click', () => {
  if (!currentDetailShotId) return;
  shots = shots.filter(s => s.id !== currentDetailShotId);
  saveShots(shots);
  document.getElementById('detail-overlay').classList.remove('open');
  renderVerlauf();
  showToast('Shot gel√∂scht');
});

// ‚îÄ‚îÄ Filter Sheet ‚îÄ‚îÄ
const filterOverlay = document.getElementById('filter-overlay');
document.getElementById('kw-label').textContent = getKW(new Date());

function buildBeanFilterChips() {
  const group = document.getElementById('bean-filter-group');
  const uniqueBeans = [...new Set(shots.map(s => s.bean))];
  group.innerHTML = uniqueBeans.map(name => {
    const bean = beans.find(b => b.name === name);
    const emoji = bean ? bean.emoji : '‚òï';
    return `<div class="opt-chip" data-filter="bean" data-val="${name}">${emoji} ${name}</div>`;
  }).join('');
  bindFilterChips();
}

function bindFilterChips() {
  document.querySelectorAll('.opt-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const group = chip.dataset.filter;
      document.querySelectorAll(`.opt-chip[data-filter="${group}"]`).forEach(c => c.classList.remove('active'));
      chip.classList.toggle('active');
    });
  });
}

document.getElementById('open-filter-btn').addEventListener('click', () => {
  buildBeanFilterChips();
  document.querySelectorAll('.opt-chip').forEach(c => {
    const val = activeFilters[c.dataset.filter];
    c.classList.toggle('active', val !== undefined && String(val) === c.dataset.val);
  });
  filterOverlay.classList.add('open');
});

filterOverlay.addEventListener('click', e => {
  if (e.target === filterOverlay) filterOverlay.classList.remove('open');
});

document.getElementById('reset-filters-btn').addEventListener('click', () => {
  document.querySelectorAll('.opt-chip').forEach(c => c.classList.remove('active'));
  activeFilters = {};
});

document.getElementById('apply-filter-btn').addEventListener('click', () => {
  activeFilters = {};
  document.querySelectorAll('.opt-chip.active').forEach(c => {
    const k = c.dataset.filter;
    let v = c.dataset.val;
    if (k === 'puck') v = v === 'true';
    activeFilters[k] = v;
  });
  filterOverlay.classList.remove('open');
  renderVerlauf();
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BOHNEN-VERWALTUNG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let selectedBeanId = beans[0]?.id || 'b1';

function renderBeans() {
  const list = document.getElementById('bean-list');
  list.innerHTML = beans.map(b => `
    <div class="bean-item ${b.id === selectedBeanId ? 'selected' : ''}" data-id="${b.id}">
      <div class="bean-dot">${b.emoji}</div>
      <div>
        <div class="bean-item-name">${b.name}</div>
        <div class="bean-item-sub">${b.sub}</div>
      </div>
      ${b.id === selectedBeanId ? '<span class="bean-check">‚úì</span>' : ''}
    </div>`).join('');

  list.querySelectorAll('.bean-item').forEach(item => {
    item.addEventListener('click', () => {
      selectedBeanId = item.dataset.id;
      const b = beans.find(x => x.id === selectedBeanId);
      document.getElementById('selected-bean-name').textContent = b.name;
      document.getElementById('selected-bean-sub').textContent = b.sub;
      closeBeanSheet();
    });
  });
}

const beanOverlay = document.getElementById('bean-sheet-overlay');
function openBeanSheet() { renderBeans(); beanOverlay.classList.add('open'); }
function closeBeanSheet() {
  beanOverlay.classList.remove('open');
  // Formular wieder schlie√üen
  document.getElementById('new-bean-form').classList.remove('open');
  document.getElementById('new-bean-name').value = '';
  document.getElementById('new-bean-sub').value = '';
}

document.getElementById('open-sheet-btn').addEventListener('click', openBeanSheet);
document.getElementById('scan-btn').addEventListener('click', openBeanSheet);
beanOverlay.addEventListener('click', e => { if (e.target === beanOverlay) closeBeanSheet(); });

// Neue Bohne
document.getElementById('new-bean-btn').addEventListener('click', () => {
  document.getElementById('new-bean-form').classList.toggle('open');
  if (document.getElementById('new-bean-form').classList.contains('open')) {
    setTimeout(() => document.getElementById('new-bean-name').focus(), 100);
  }
});

document.getElementById('add-bean-confirm').addEventListener('click', () => {
  const name = document.getElementById('new-bean-name').value.trim();
  const sub = document.getElementById('new-bean-sub').value.trim() || 'Keine Angabe';
  if (!name) { showToast('Bitte Name eingeben'); return; }

  const emojis = ['ü´ò','‚òï','üåø','üü§','‚≠ê','üî•','üíß','üå±'];
  const newBean = {
    id: genId(),
    name,
    sub,
    emoji: emojis[beans.length % emojis.length]
  };
  beans.unshift(newBean);
  saveBeans(beans);
  selectedBeanId = newBean.id;
  document.getElementById('selected-bean-name').textContent = newBean.name;
  document.getElementById('selected-bean-sub').textContent = newBean.sub;
  closeBeanSheet();
  showToast(`"${name}" hinzugef√ºgt ‚úì`);
});

// Barcode-Scan Hinweis
document.getElementById('scan-action-btn').addEventListener('click', () => {
  showToast('Barcode-Scanner nicht verf√ºgbar in Safari PWA');
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DASHBOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function buildDashboard() {
  const el = document.getElementById('dash-content');
  el.innerHTML = '';

  if (shots.length === 0) {
    el.innerHTML = '<div style="text-align:center;padding:60px 20px;color:var(--text-secondary)"><div style="font-size:40px;margin-bottom:12px">‚òï</div><div style="font-size:14px;font-weight:500">Noch keine Shots gespeichert</div></div>';
    return;
  }

  const total = shots.length;
  const avgRatio = shots.reduce((a,s) => a + s.ratio, 0) / total;
  const green = shots.filter(s => getAmpel(s.ratio) === 'green').length;
  const now = new Date();
  const MONTHS_FULL = ['Januar','Februar','M√§rz','April','Mai','Juni','Juli','August','September','Oktober','November','Dezember'];
  document.getElementById('dash-subtitle').textContent = `${MONTHS_FULL[now.getMonth()]} ${now.getFullYear()}`;

  // Shots diese Woche
  const thisWeek = shots.filter(s => {
    const d = s.date instanceof Date ? s.date : new Date(s.date);
    return (now - d) / 86400000 <= 7;
  }).length;
  const lastWeek = shots.filter(s => {
    const d = s.date instanceof Date ? s.date : new Date(s.date);
    const days = (now - d) / 86400000;
    return days > 7 && days <= 14;
  }).length;
  const weekDelta = thisWeek - lastWeek;

  el.innerHTML += `
  <div class="kpi-row">
    <div class="kpi-card"><div class="kpi-value">${total}</div><div class="kpi-label">Shots</div>
      <div class="kpi-delta ${weekDelta > 0 ? 'up' : weekDelta < 0 ? 'down' : 'neutral'}">${weekDelta > 0 ? '‚Üë' : weekDelta < 0 ? '‚Üì' : '‚Äì'} ${Math.abs(weekDelta)} diese Woche</div></div>
    <div class="kpi-card"><div class="kpi-value">${Math.round(green/total*100)}%</div><div class="kpi-label">üü¢ Quote</div>
      <div class="kpi-delta neutral">von ${total} Shots</div></div>
    <div class="kpi-card"><div class="kpi-value">1:${avgRatio.toFixed(1)}</div><div class="kpi-label">√ò Ratio</div>
      <div class="kpi-delta ${getAmpel(avgRatio) === 'green' ? 'up' : 'down'}">${getAmpel(avgRatio) === 'green' ? '‚úì Ideal' : '‚Üí Justieren'}</div></div>
  </div>`;

  // Insights
  const insights = generateInsights();
  if (insights.length > 0) {
    el.innerHTML += `<div class="dash-section"><div class="dash-section-title">Insights</div>${insights.map(i => `
    <div class="insight-card ${i.type}">
      <div class="insight-icon">${i.icon}</div>
      <div><div class="insight-title">${i.title}</div><div class="insight-text">${i.text}</div></div>
    </div>`).join('')}</div>`;
  }

  // Qualit√§t & Ratio
  const gCnt = shots.filter(s => getAmpel(s.ratio) === 'green').length;
  const yCnt = shots.filter(s => getAmpel(s.ratio) === 'yellow').length;
  const rCnt = shots.filter(s => getAmpel(s.ratio) === 'red').length;
  const donutR=44,cx=56,cy=56,circ=2*Math.PI*donutR;
  const gPct=gCnt/total, yPct=yCnt/total, rPct=rCnt/total;
  const gDash=gPct*circ, yDash=yPct*circ, rDash=rPct*circ;
  const gOff=0, yOff=-gDash, rOff=-(gDash+yDash);

  const last8 = shots.slice(0,8).reverse();
  const ratioMin=1.0, ratioMax=3.5, rh=70, rw=260;
  const ratioPoints = last8.map((s,i) => {
    const x = i*(rw/(last8.length-1));
    const y = rh-((s.ratio-ratioMin)/(ratioMax-ratioMin))*rh;
    return `${x},${y}`;
  }).join(' ');
  const ratioColors = last8.map(s => ({green:'var(--green)',yellow:'var(--yellow)',red:'var(--red)'}[getAmpel(s.ratio)]));

  el.innerHTML += `<div class="dash-section"><div class="dash-section-title">Qualit√§t & Ratio</div>
  <div class="chart-card">
    <div class="chart-title">Ampel-Verteilung</div>
    <div class="donut-row">
      <svg width="112" height="112" viewBox="0 0 112 112">
        <circle cx="${cx}" cy="${cy}" r="${donutR}" fill="none" stroke="var(--bg)" stroke-width="16"/>
        <circle cx="${cx}" cy="${cy}" r="${donutR}" fill="none" stroke="var(--green)" stroke-width="16" stroke-dasharray="${gDash} ${circ-gDash}" stroke-dashoffset="${gOff}" transform="rotate(-90 ${cx} ${cy})"/>
        <circle cx="${cx}" cy="${cy}" r="${donutR}" fill="none" stroke="var(--yellow)" stroke-width="16" stroke-dasharray="${yDash} ${circ-yDash}" stroke-dashoffset="${yOff}" transform="rotate(-90 ${cx} ${cy})"/>
        <circle cx="${cx}" cy="${cy}" r="${donutR}" fill="none" stroke="var(--red)" stroke-width="16" stroke-dasharray="${rDash} ${circ-rDash}" stroke-dashoffset="${rOff}" transform="rotate(-90 ${cx} ${cy})"/>
        <text x="${cx}" y="${cy-6}" text-anchor="middle" font-family="DM Sans" font-size="18" font-weight="700" fill="var(--text-primary)">${Math.round(gPct*100)}%</text>
        <text x="${cx}" y="${cy+10}" text-anchor="middle" font-family="DM Sans" font-size="10" fill="var(--text-secondary)">gr√ºn</text>
      </svg>
      <div class="donut-legend">
        <div class="donut-legend-item"><div class="donut-legend-dot" style="background:var(--green)"></div><span class="donut-legend-label">Gr√ºn</span><span class="donut-legend-val">${gCnt} (${Math.round(gPct*100)}%)</span></div>
        <div class="donut-legend-item"><div class="donut-legend-dot" style="background:var(--yellow)"></div><span class="donut-legend-label">Gelb</span><span class="donut-legend-val">${yCnt} (${Math.round(yPct*100)}%)</span></div>
        <div class="donut-legend-item"><div class="donut-legend-dot" style="background:var(--red)"></div><span class="donut-legend-label">Rot</span><span class="donut-legend-val">${rCnt} (${Math.round(rPct*100)}%)</span></div>
      </div>
    </div>
  </div>
  <div class="chart-card">
    <div class="chart-title">Ratio-Verlauf (letzte ${last8.length} Shots)</div>
    <svg class="chart-svg" height="90" viewBox="0 0 260 90">
      <line x1="0" y1="70" x2="260" y2="70" class="chart-axis"/>
      <polyline points="${ratioPoints}" fill="none" stroke="var(--accent)" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/>
      ${last8.map((s,i) => {
        const x=i*(rw/(last8.length-1));
        const y=rh-((s.ratio-ratioMin)/(ratioMax-ratioMin))*rh;
        const d = s.date instanceof Date ? s.date : new Date(s.date);
        return `<circle cx="${x}" cy="${y}" r="4" fill="${ratioColors[i]}"/>
        <text x="${x}" y="${y-8}" text-anchor="middle" class="chart-label">${s.ratio.toFixed(1)}</text>`;
      }).join('')}
      <text x="0" y="85" class="chart-label">${fmtDate(last8[0].date instanceof Date ? last8[0].date : new Date(last8[0].date)).split(',')[1].trim()}</text>
      <text x="260" y="85" text-anchor="end" class="chart-label">${fmtDate(last8[last8.length-1].date instanceof Date ? last8[last8.length-1].date : new Date(last8[last8.length-1].date)).split(',')[1].trim()}</text>
    </svg>
  </div></div>`;

  // Zeitliche Muster
  const byDay = [0,0,0,0,0,0,0];
  shots.forEach(s => { const d = s.date instanceof Date ? s.date : new Date(s.date); byDay[d.getDay()]++; });
  const maxDay = Math.max(...byDay) || 1;
  const dayLabels = ['So','Mo','Di','Mi','Do','Fr','Sa'];
  const barW=30, barH=55, barGap=11;

  const byHour = Array(24).fill(0);
  shots.forEach(s => { const d = s.date instanceof Date ? s.date : new Date(s.date); byHour[d.getHours()]++; });

  el.innerHTML += `<div class="dash-section"><div class="dash-section-title">Zeitliche Muster</div>
  <div class="chart-card">
    <div class="chart-title">Shots nach Wochentag</div>
    <svg class="chart-svg" height="${barH+28}" viewBox="0 0 ${7*(barW+barGap)-barGap} ${barH+28}">
      ${byDay.map((cnt,i) => {
        const h = cnt > 0 ? (cnt/maxDay)*barH : 2;
        const x = i*(barW+barGap);
        const y = barH-h;
        const isToday = i === new Date().getDay();
        const col = isToday ? 'var(--accent)' : (i===0||i===6 ? 'var(--accent-light)' : '#D4CFC8');
        return `<rect x="${x}" y="${y}" width="${barW}" height="${h}" rx="6" fill="${col}"/>
        <text x="${x+barW/2}" y="${barH+12}" text-anchor="middle" class="chart-label" ${isToday ? `fill="var(--accent)"` : ''}>${dayLabels[i]}</text>
        ${cnt>0 ? `<text x="${x+barW/2}" y="${y-4}" text-anchor="middle" class="chart-val">${cnt}</text>` : ''}`;
      }).join('')}
    </svg>
  </div>
  <div class="chart-card">
    <div class="chart-title">Tageszeit-Verteilung</div>
    <div style="display:flex;gap:6px;">
      ${[['üåÖ','Morgens','6‚Äì10h',[6,10]],['‚òÄÔ∏è','Mittags','10‚Äì14h',[10,14]],['üåÜ','Nachm.','14‚Äì18h',[14,18]],['üåô','Abends','18+h',[18,24]]].map(([emoji,label,sub,range]) => {
        const cnt = byHour.slice(...range).reduce((a,b) => a+b, 0);
        return `<div style="flex:1;background:var(--bg);border-radius:12px;padding:8px 6px;text-align:center;">
          <div style="font-size:16px">${emoji}</div>
          <div style="font-size:18px;font-weight:700;color:var(--text-primary);margin:2px 0">${cnt}</div>
          <div style="font-size:9px;color:var(--text-secondary);font-weight:600">${label}</div>
        </div>`;
      }).join('')}
    </div>
  </div></div>`;

  // Bohnen-Analyse
  const beanNames = [...new Set(shots.map(s => s.bean))];
  const beanStats = beanNames.map(name => {
    const bs = shots.filter(s => s.bean === name);
    const avgR = bs.reduce((a,s) => a+s.ratio, 0) / bs.length;
    const avgD = bs.reduce((a,s) => a+s.dosis, 0) / bs.length;
    const greenQ = Math.round(bs.filter(s => getAmpel(s.ratio) === 'green').length / bs.length * 100);
    return { name, cnt: bs.length, avgR, avgD, greenQ };
  });
  const maxGreenQ = Math.max(...beanStats.map(b => b.greenQ));

  el.innerHTML += `<div class="dash-section"><div class="dash-section-title">Bohnen-Analyse</div>
  <div class="chart-card">
    <div class="chart-title">√ò Ratio & üü¢ Quote pro Bohne</div>
    ${beanStats.map(b => {
      const col = getAmpel(b.avgR) === 'green' ? 'var(--green)' : getAmpel(b.avgR) === 'yellow' ? 'var(--yellow)' : 'var(--red)';
      return `<div style="margin-bottom:10px;">
        <div style="display:flex;justify-content:space-between;margin-bottom:4px;">
          <span style="font-size:12px;font-weight:500;color:var(--text-primary)">${b.name} <span style="font-weight:400;color:var(--text-secondary)">(${b.cnt}√ó)</span></span>
          <span style="font-size:12px;color:${col};font-weight:600">1:${b.avgR.toFixed(1)} ¬∑ ${b.greenQ}% üü¢</span>
        </div>
        <div style="height:8px;background:var(--bg);border-radius:4px;overflow:hidden;">
          <div style="height:100%;width:${Math.min(b.greenQ,100)}%;background:${col};border-radius:4px;transition:width 0.4s;"></div>
        </div>
      </div>`;
    }).join('')}
  </div></div>`;

  // Equipment
  const withPuck = shots.filter(s => s.puck);
  const withoutPuck = shots.filter(s => !s.puck);
  const puckGreen = withPuck.length > 0 ? Math.round(withPuck.filter(s => getAmpel(s.ratio) === 'green').length / withPuck.length * 100) : 0;
  const noPuckGreen = withoutPuck.length > 0 ? Math.round(withoutPuck.filter(s => getAmpel(s.ratio) === 'green').length / withoutPuck.length * 100) : 0;
  const bodenlos = shots.filter(s => s.basket === 'Bodenlos');
  const normal = shots.filter(s => s.basket === 'Normal');
  const bodenlosGreen = bodenlos.length > 0 ? Math.round(bodenlos.filter(s => getAmpel(s.ratio) === 'green').length / bodenlos.length * 100) : 0;
  const normalGreen = normal.length > 0 ? Math.round(normal.filter(s => getAmpel(s.ratio) === 'green').length / normal.length * 100) : 0;

  el.innerHTML += `<div class="dash-section"><div class="dash-section-title">Equipment</div>
  <div class="chart-card">
    <div class="chart-title">Puck Screen Einfluss auf üü¢ Quote</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <div style="background:var(--green-bg);border-radius:14px;padding:12px;text-align:center;">
        <div style="font-size:11px;color:var(--green);font-weight:600;margin-bottom:6px;">Mit Puck Screen</div>
        <div style="font-size:28px;font-weight:700;color:var(--green)">${puckGreen}%</div>
        <div style="font-size:10px;color:var(--text-secondary);margin-top:2px">${withPuck.length} Shots</div>
      </div>
      <div style="background:var(--bg);border-radius:14px;padding:12px;text-align:center;">
        <div style="font-size:11px;color:var(--text-secondary);font-weight:600;margin-bottom:6px;">Ohne Puck Screen</div>
        <div style="font-size:28px;font-weight:700;color:var(--text-primary)">${noPuckGreen}%</div>
        <div style="font-size:10px;color:var(--text-secondary);margin-top:2px">${withoutPuck.length} Shots</div>
      </div>
    </div>
  </div>
  <div class="chart-card">
    <div class="chart-title">Siebtr√§ger-Vergleich</div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
      <div style="background:var(--accent-light);border-radius:14px;padding:12px;text-align:center;">
        <div style="font-size:11px;color:var(--accent);font-weight:600;margin-bottom:6px;">Bodenlos</div>
        <div style="font-size:28px;font-weight:700;color:var(--accent)">${bodenlosGreen}%</div>
        <div style="font-size:10px;color:var(--text-secondary);margin-top:2px">${bodenlos.length} Shots</div>
      </div>
      <div style="background:var(--bg);border-radius:14px;padding:12px;text-align:center;">
        <div style="font-size:11px;color:var(--text-secondary);font-weight:600;margin-bottom:6px;">Normal</div>
        <div style="font-size:28px;font-weight:700;color:var(--text-primary)">${normalGreen}%</div>
        <div style="font-size:10px;color:var(--text-secondary);margin-top:2px">${normal.length} Shots</div>
      </div>
    </div>
  </div></div>`;
}

function generateInsights() {
  const insights = [];
  const beanNames = [...new Set(shots.map(s => s.bean))];

  beanNames.forEach(name => {
    const bs = shots.filter(s => s.bean === name);
    if (bs.length < 2) return;
    const redShots = bs.filter(s => getAmpel(s.ratio) === 'red');
    const avgZ = bs.reduce((a,s) => a + (s.zeit || 27), 0) / bs.length;
    if (redShots.length >= 2) {
      const avgR = bs.reduce((a,s) => a+s.ratio, 0) / bs.length;
      const direction = avgR < 1.8 ? 'zu kurz (Mahlgrad feiner?)' : 'zu lang (Mahlgrad grober?)';
      insights.push({type:'warn',icon:'‚ö†Ô∏è',title:`${name}: Shots oft au√üerhalb`,text:`${redShots.length} von ${bs.length} Shots rot. √ò Ratio 1:${avgR.toFixed(1)} ‚Äì Durchlauf ${direction}`});
    }
    if (avgZ < 24 && bs.length >= 2)
      insights.push({type:'tip',icon:'üîß',title:`${name}: Durchlauf zu kurz`,text:`√ò ${avgZ.toFixed(0)}s ‚Äì ideal w√§ren 24‚Äì32s. Mahlgrad feiner stellen.`});
    if (avgZ > 32 && bs.length >= 2)
      insights.push({type:'tip',icon:'üîß',title:`${name}: Durchlauf zu lang`,text:`√ò ${avgZ.toFixed(0)}s ‚Äì ideal w√§ren 24‚Äì32s. Mahlgrad grober stellen.`});
  });

  const withPuck = shots.filter(s => s.puck);
  const withoutPuck = shots.filter(s => !s.puck);
  if (withPuck.length >= 2 && withoutPuck.length >= 2) {
    const pG = withPuck.filter(s => getAmpel(s.ratio) === 'green').length / withPuck.length;
    const nG = withoutPuck.filter(s => getAmpel(s.ratio) === 'green').length / withoutPuck.length;
    const diff = Math.round((pG - nG) * 100);
    if (Math.abs(diff) >= 10)
      insights.push({type:'good',icon:'‚úÖ',title:'Puck Screen macht einen Unterschied',text:`Mit Puck Screen ${Math.round(pG*100)}% gr√ºn vs. ohne ${Math.round(nG*100)}% ‚Äì Œî ${diff > 0 ? '+' : ''}${diff}%.`});
  }

  const beanQuality = [...new Set(shots.map(s => s.bean))].map(name => {
    const bs = shots.filter(s => s.bean === name);
    return { name, greenQ: bs.filter(s => getAmpel(s.ratio) === 'green').length / bs.length, cnt: bs.length };
  }).filter(b => b.cnt >= 2).sort((a,b) => b.greenQ - a.greenQ);
  if (beanQuality.length >= 2)
    insights.push({type:'good',icon:'üèÜ',title:`Beste Bohne: ${beanQuality[0].name}`,text:`${Math.round(beanQuality[0].greenQ*100)}% gr√ºn bei ${beanQuality[0].cnt} Shots ‚Äì deine zuverl√§ssigste Wahl.`});

  if (shots.length >= 6) {
    const recent = shots.slice(0,5);
    const older = shots.slice(5);
    const rG = recent.filter(s => getAmpel(s.ratio) === 'green').length / recent.length;
    const oG = older.filter(s => getAmpel(s.ratio) === 'green').length / older.length;
    const diff = Math.round((rG - oG) * 100);
    if (diff >= 10)  insights.push({type:'good',icon:'üìà',title:'Du wirst besser!',text:`Letzte 5 Shots: ${Math.round(rG*100)}% gr√ºn ‚Äì ${diff}% mehr als davor.`});
    if (diff <= -10) insights.push({type:'warn',icon:'üìâ',title:'Qualit√§t zuletzt gesunken',text:`Letzte 5 Shots nur ${Math.round(rG*100)}% gr√ºn ‚Äì ${Math.abs(diff)}% weniger als davor.`});
  }

  return insights.slice(0, 4);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SERVICE WORKER REGISTRIERUNG
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('./service-worker.js')
      .then(reg => console.log('SW registriert ‚úì', reg.scope))
      .catch(err => console.log('SW Fehler:', err));
  });
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ
loadLastShotDefaults();
</script>
</body>
</html>
